name: Build and Push Docker Images

on:
  push:
    branches:
      - "develop"

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Extract service names from docker-compose.develop.yml
      id: services
      run: |
        echo "SERVICES=$(docker compose -f docker-compose.develop.yml --env-file _environment/.env.develop config --services | tr '\n' ' ')" >> $GITHUB_ENV

    - name: Build and push Docker images
      run: |
        for SERVICE in $SERVICES; do
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/$SERVICE:latest"
          docker compose build $SERVICE
          docker tag $SERVICE $IMAGE_NAME
          docker push $IMAGE_NAME
        done
